worker_processes 1; # Minimal for lightweight operation
events {
    worker_connections 1024;
}

http {
    server_tokens off;
    lua_package_path "/usr/local/openresty/lualib/?.lua;;"; # Include Lua scripts

    limit_req_zone $binary_remote_addr zone=perip:10m rate=10r/m;

    upstream solana_validator {
        server 127.0.0.1:8899; # Solana validator RPC port
    }

    server {
        listen 18899;
        server_name localhost;
        more_set_headers 'Server: None';

        # RPC filtering for getSlot + getHighestSnapshotSlot
        location / {
            limit_req zone=perip burst=1 nodelay;
            limit_req_status 429;

            access_by_lua_block {
                ngx.req.read_body()
                local cjson = require "cjson"
                local body = ngx.req.get_body_data()
                if body then
                    local json = cjson.decode(body)
                    local allowed_methods = {
                        getSlot = true,
                        getHighestSnapshotSlot = true
                    }
                    if not allowed_methods[json.method] then
                        ngx.status = 403
                        ngx.say(cjson.encode({
                            jsonrpc = "2.0",
                            error = { code = -32601, message = "Method not allowed" },
                            id = json.id or 1
                        }))
                        return ngx.exit(ngx.HTTP_FORBIDDEN)
                    end
                end
            }
            proxy_pass http://solana_validator; # Points to 127.0.0.1:8899
            proxy_set_header Host $host;
        }

        # Snapshot proxy (optional separate path)
        location /snapshot {
            proxy_pass http://solana_validator; # Points to 127.0.0.1:8899
            proxy_set_header Host $host;
        }
    }
}
